name: Build changed images

# Controls when the workflow will run
on:
  push:
    branches: [ "main" ]

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  check_updates:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: "Determine which images should be built"
        id: changed_files
        uses: tj-actions/changed-files@v34
        with:
          json: "true"
          dir_names: "true"
          dir_names_max_depth: "1"
              outputs:
    outputs:
      changed_images: ${{ steps.changed_files.outputs.all_changed_files }}

  auto_build:
    needs:
      - "check_updates"

    strategy:
      fail-fast: true
      matrix:
        image: ${{fromJson(needs.check_updates.outputs.changed_images)}}

    uses: ./.github/workflows/build.yml
    with:
      image: ${{ matrix.image }}
